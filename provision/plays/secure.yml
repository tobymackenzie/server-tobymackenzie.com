#-@ https://ryaneschinger.com/blog/securing-a-server-with-ansible/
#-# unattended upgrades are set up to do automated security updates in 'packageManager' play
- name: secure server
  become: true
  handlers:
    - include: ../handlers.yml
  hosts: all
  tasks:
    - name: disallow root ssh
      lineinfile:
        dest: /etc/ssh/sshd_config
        line: 'PermitRootLogin no'
        regexp: '^PermitRootLogin'
        state: present
      notify: restart ssh
    - name: prevent ssh password auth
      lineinfile:
        dest: /etc/ssh/sshd_config
        line: 'PasswordAuthentication no'
        regexp: '^PasswordAuthentication'
        state: present
      notify: restart ssh
    - name: install security packages
      apt:
        name:
          - 'fail2ban'
          - 'ufw'
          - 'unattended-upgrades'
        state: present
    - name: block all ports by default
      ufw:
        policy: deny
        state: enabled
    - name: configure allowed ports
      ufw:
        port: '{{item.port}}'
        proto: '{{item.proto}}'
        rule: allow
      with_items:
        - '{{fw_allow}}'
